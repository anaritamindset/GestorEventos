{% extends "base.html" %}

{% block title %}Gestão Automática - Gestor Wellness{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>Gestão Automática</h1>
    <p style="color: var(--color-text-light);">Automatize a criação de formulários, sincronização de participantes e
        envio de certificados.</p>
</div>

<!-- Status da Conexão Google -->
<div class="card" style="margin-bottom: 2rem;">
    <h2 style="margin-bottom: 1rem;">
        <i class="fab fa-google"></i> Conexão Google
    </h2>
    {% if google_connected %}
    <div style="display: flex; align-items: center; gap: 10px; padding: 1rem; background: #E6F4EA; border-radius: 8px;">
        <i class="fas fa-check-circle" style="color: var(--color-primary); font-size: 1.5rem;"></i>
        <div>
            <strong>Conectado</strong>
            <p style="margin: 0; color: var(--color-text-light); font-size: 0.9rem;">Conta Google autenticada com
                sucesso</p>
        </div>
    </div>
    {% else %}
    <div
        style="display: flex; align-items: center; gap: 10px; padding: 1rem; background: #FEF3E9; border-radius: 8px; margin-bottom: 1rem;">
        <i class="fas fa-exclamation-triangle" style="color: var(--color-secondary); font-size: 1.5rem;"></i>
        <div>
            <strong>Não conectado</strong>
            <p style="margin: 0; color: var(--color-text-light); font-size: 0.9rem;">É necessário autenticar com o
                Google para usar as funcionalidades automáticas</p>
        </div>
    </div>
    <a href="{{ url_for('main.google_authenticate') }}" class="btn btn-primary">
        <i class="fab fa-google"></i> Conectar com Google
    </a>
    {% endif %}
</div>

<!-- Formulários Disponíveis -->
{% if google_connected %}
<div class="card" style="margin-bottom: 2rem;">
    <h2 style="margin-bottom: 1rem;">
        <i class="fas fa-file-alt"></i> Formulários Google Disponíveis
    </h2>
    <p style="color: var(--color-text-light); margin-bottom: 1rem;">
        Formulários recentes no seu Google Drive que podem ser associados a eventos
    </p>

    <button onclick="loadRecentForms()" class="btn btn-outline" style="margin-bottom: 1rem;">
        <i class="fas fa-sync"></i> Carregar Formulários
    </button>

    <div id="forms-list" style="display: none;">
        <div style="overflow-x: auto; margin-top: 1rem;">
            <table id="forms-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--color-border); text-align: left;">
                        <th style="padding: 0.75rem;">Nome do Formulário</th>
                        <th style="padding: 0.75rem;">Data do Evento</th>
                        <th style="padding: 0.75rem;">Proprietário</th>
                        <th style="padding: 0.75rem;">Criado</th>
                        <th style="padding: 0.75rem;">Ações</th>
                    </tr>
                </thead>
                <tbody id="forms-tbody">
                    <!-- Preenchido via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="forms-loading" style="display: none; text-align: center; padding: 2rem;">
        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--color-primary);"></i>
        <p style="margin-top: 1rem; color: var(--color-text-light);">A carregar formulários...</p>
    </div>

    <div id="forms-empty" style="display: none; text-align: center; padding: 2rem; color: var(--color-text-light);">
        <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
        <p>Nenhum formulário encontrado no Google Drive</p>
    </div>
</div>

<!-- Lista de Eventos com Automação -->
<div class="card">
    <h2 style="margin-bottom: 1.5rem;">
        <i class="fas fa-calendar-check"></i> Eventos
    </h2>

    {% if eventos %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--color-border); text-align: left;">
                    <th style="padding: 1rem;">Evento</th>
                    <th style="padding: 1rem;">Data</th>
                    <th style="padding: 1rem;">Participantes</th>
                    <th style="padding: 1rem;">Google Form</th>
                    <th style="padding: 1rem;">Google Sheet</th>
                    <th style="padding: 1rem;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for evento in eventos %}
                <tr style="border-bottom: 1px solid var(--color-border);">
                    <td style="padding: 1rem;">
                        <strong>{{ evento.nome }}</strong>
                    </td>
                    <td style="padding: 1rem;">
                        {{ evento.data_inicio.strftime('%d/%m/%Y') }}
                    </td>
                    <td style="padding: 1rem;">
                        {{ evento.get_participant_count() }}
                    </td>
                    <td style="padding: 1rem;">
                        {% if evento.google_form_id %}
                        <a href="https://docs.google.com/forms/d/{{ evento.google_form_id }}/edit" target="_blank"
                            class="btn btn-outline btn-sm">
                            <i class="fas fa-external-link-alt"></i> Ver Form
                        </a>
                        {% else %}
                        <span style="color: var(--color-text-light); font-size: 0.9rem;">Não criado</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">
                        {% if evento.google_sheet_id %}
                        <a href="https://docs.google.com/spreadsheets/d/{{ evento.google_sheet_id }}/edit"
                            target="_blank" class="btn btn-outline btn-sm">
                            <i class="fas fa-external-link-alt"></i> Ver Sheet
                        </a>
                        {% else %}
                        <span style="color: var(--color-text-light); font-size: 0.9rem;">Não criado</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 5px;">
                            {% if not evento.google_form_id %}
                            <form method="POST"
                                action="{{ url_for('main.create_event_automation', evento_id=evento.id) }}"
                                style="display: inline;">
                                <button type="submit" class="btn btn-primary btn-sm" title="Criar automação">
                                    <i class="fas fa-magic"></i> Automatizar
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="{{ url_for('main.sync_event_responses', evento_id=evento.id) }}"
                                style="display: inline;">
                                <button type="submit" class="btn btn-outline btn-sm" title="Sincronizar respostas">
                                    <i class="fas fa-sync"></i> Sincronizar
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: var(--color-text-light);">
        <i class="fas fa-calendar-times" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
        <p>Nenhum evento encontrado</p>
        <a href="{{ url_for('main.criar_evento') }}" class="btn btn-primary" style="margin-top: 1rem;">
            <i class="fas fa-plus"></i> Criar Evento
        </a>
    </div>
    {% endif %}
</div>
{% endif %}

<script>
// Load recent Google Forms from Drive
async function loadRecentForms() {
    const loadingDiv = document.getElementById('forms-loading');
    const listDiv = document.getElementById('forms-list');
    const emptyDiv = document.getElementById('forms-empty');
    const tbody = document.getElementById('forms-tbody');

    // Show loading
    loadingDiv.style.display = 'block';
    listDiv.style.display = 'none';
    emptyDiv.style.display = 'none';

    try {
        const response = await fetch('{{ url_for("main.list_google_forms") }}');
        const data = await response.json();

        loadingDiv.style.display = 'none';

        if (data.success && data.forms.length > 0) {
            // Populate table
            tbody.innerHTML = '';
            data.forms.forEach(form => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--color-border)';

                const createdDate = new Date(form.created_time).toLocaleDateString('pt-PT');

                // Display event date if extracted, otherwise show created date
                const eventDateDisplay = form.event_date
                    ? `<strong style="color: var(--color-primary);">${form.event_date}</strong>`
                    : `<span style="color: var(--color-text-light); font-size: 0.85rem;">Não identificada</span>`;

                row.innerHTML = `
                    <td style="padding: 0.75rem;">
                        <strong>${form.name}</strong>
                    </td>
                    <td style="padding: 0.75rem;">
                        ${eventDateDisplay}
                    </td>
                    <td style="padding: 0.75rem; color: var(--color-text-light); font-size: 0.9rem;">
                        ${form.owner || 'Desconhecido'}
                    </td>
                    <td style="padding: 0.75rem; color: var(--color-text-light); font-size: 0.9rem;">
                        ${createdDate}
                    </td>
                    <td style="padding: 0.75rem;">
                        <div style="display: flex; gap: 5px;">
                            <a href="${form.url}" target="_blank" class="btn btn-outline btn-sm" title="Ver formulário">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <button onclick="showLinkFormModal('${form.id}', '${form.name}')" class="btn btn-primary btn-sm" title="Associar a evento">
                                <i class="fas fa-link"></i> Associar
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            listDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'block';
        }
    } catch (error) {
        loadingDiv.style.display = 'none';
        alert('Erro ao carregar formulários: ' + error.message);
    }
}

// Show modal to select event for linking
function showLinkFormModal(formId, formName) {
    const eventos = {{ eventos_json | tojson }};

    if (!eventos || eventos.length === 0) {
        alert('Nenhum evento disponível. Crie um evento primeiro.');
        return;
    }

    // Create simple modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;

    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    `;

    let optionsHTML = '';
    eventos.forEach(evento => {
        if (!evento.google_form_id) {
            optionsHTML += `<option value="${evento.id}">${evento.nome} (${new Date(evento.data_inicio).toLocaleDateString('pt-PT')})</option>`;
        }
    });

    modalContent.innerHTML = `
        <h3 style="margin-bottom: 1rem;">Associar Formulário</h3>
        <p style="color: var(--color-text-light); margin-bottom: 1.5rem;">
            Associar "<strong>${formName}</strong>" a qual evento?
        </p>
        <select id="evento-select" class="form-input" style="width: 100%; margin-bottom: 1.5rem;">
            <option value="">Selecione um evento...</option>
            ${optionsHTML}
        </select>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="this.closest('[style*=fixed]').remove()" class="btn btn-outline">
                Cancelar
            </button>
            <button onclick="linkFormToEvent('${formId}')" class="btn btn-primary">
                <i class="fas fa-link"></i> Associar
            </button>
        </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    // Close on background click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Link form to selected event
function linkFormToEvent(formId) {
    const select = document.getElementById('evento-select');
    const eventoId = select.value;

    if (!eventoId) {
        alert('Por favor, selecione um evento');
        return;
    }

    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/automation/link/${eventoId}/${formId}`;
    document.body.appendChild(form);
    form.submit();
}
</script>

{% endblock %}